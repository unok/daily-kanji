import questionsElementary from '../data/questions/questions-elementary.json'
// Elementary 1 parts
import questionsElementary1Part1 from '../data/questions/questions-elementary1-part1.json'
import questionsElementary1Part2 from '../data/questions/questions-elementary1-part2.json'
import questionsElementary1Part3 from '../data/questions/questions-elementary1-part3.json'
import questionsElementary1Part4 from '../data/questions/questions-elementary1-part4.json'
import questionsElementary1Part5 from '../data/questions/questions-elementary1-part5.json'
import questionsElementary1Part6 from '../data/questions/questions-elementary1-part6.json'
// Elementary 2 parts
import questionsElementary2Part1 from '../data/questions/questions-elementary2-part1.json'
import questionsElementary2Part2 from '../data/questions/questions-elementary2-part2.json'
import questionsElementary2Part3 from '../data/questions/questions-elementary2-part3.json'
import questionsElementary2Part4 from '../data/questions/questions-elementary2-part4.json'
import questionsElementary2Part5 from '../data/questions/questions-elementary2-part5.json'
import questionsElementary2Part6 from '../data/questions/questions-elementary2-part6.json'
import questionsElementary2Part7 from '../data/questions/questions-elementary2-part7.json'
import questionsElementary2Part8 from '../data/questions/questions-elementary2-part8.json'
// Elementary 3 parts
import questionsElementary3Part1 from '../data/questions/questions-elementary3-part1.json'
import questionsElementary3Part2 from '../data/questions/questions-elementary3-part2.json'
import questionsElementary3Part3 from '../data/questions/questions-elementary3-part3.json'
import questionsElementary3Part4 from '../data/questions/questions-elementary3-part4.json'
import questionsElementary3Part5 from '../data/questions/questions-elementary3-part5.json'
import questionsElementary3Part6 from '../data/questions/questions-elementary3-part6.json'
import questionsElementary3Part7 from '../data/questions/questions-elementary3-part7.json'
import questionsElementary3Part8 from '../data/questions/questions-elementary3-part8.json'
// Elementary 4 parts
import questionsElementary4Part1 from '../data/questions/questions-elementary4-part1.json'
import questionsElementary4Part2 from '../data/questions/questions-elementary4-part2.json'
import questionsElementary4Part3 from '../data/questions/questions-elementary4-part3.json'
import questionsElementary4Part4 from '../data/questions/questions-elementary4-part4.json'
import questionsElementary4Part5 from '../data/questions/questions-elementary4-part5.json'
import questionsElementary4Part6 from '../data/questions/questions-elementary4-part6.json'
import questionsElementary4Part7 from '../data/questions/questions-elementary4-part7.json'
import questionsElementary4Part8 from '../data/questions/questions-elementary4-part8.json'
// Elementary 5 parts
import questionsElementary5Part1 from '../data/questions/questions-elementary5-part1.json'
import questionsElementary5Part2 from '../data/questions/questions-elementary5-part2.json'
import questionsElementary5Part3 from '../data/questions/questions-elementary5-part3.json'
import questionsElementary5Part4 from '../data/questions/questions-elementary5-part4.json'
import questionsElementary5Part5 from '../data/questions/questions-elementary5-part5.json'
import questionsElementary5Part6 from '../data/questions/questions-elementary5-part6.json'
import questionsElementary5Part7 from '../data/questions/questions-elementary5-part7.json'
import questionsElementary5Part8 from '../data/questions/questions-elementary5-part8.json'
// Elementary 6 parts
import questionsElementary6Part1 from '../data/questions/questions-elementary6-part1.json'
import questionsElementary6Part2 from '../data/questions/questions-elementary6-part2.json'
import questionsElementary6Part3 from '../data/questions/questions-elementary6-part3.json'
import questionsElementary6Part4 from '../data/questions/questions-elementary6-part4.json'
import questionsElementary6Part5 from '../data/questions/questions-elementary6-part5.json'
import questionsElementary6Part6 from '../data/questions/questions-elementary6-part6.json'
import questionsElementary6Part7 from '../data/questions/questions-elementary6-part7.json'
import questionsElementary6Part8 from '../data/questions/questions-elementary6-part8.json'
import questionsElementary6Part9 from '../data/questions/questions-elementary6-part9.json'
// Junior parts
import questionsJuniorPart1 from '../data/questions/questions-junior-part1.json'
import questionsJuniorPart2 from '../data/questions/questions-junior-part2.json'
import questionsJuniorPart3 from '../data/questions/questions-junior-part3.json'
import questionsJuniorPart4 from '../data/questions/questions-junior-part4.json'
import questionsJuniorPart5 from '../data/questions/questions-junior-part5.json'
import questionsJuniorPart6 from '../data/questions/questions-junior-part6.json'
import questionsJuniorPart7 from '../data/questions/questions-junior-part7.json'
import questionsJuniorPart8 from '../data/questions/questions-junior-part8.json'
import questionsJuniorPart9 from '../data/questions/questions-junior-part9.json'
import questionsJuniorPart10 from '../data/questions/questions-junior-part10.json'
import questionsJuniorPart11 from '../data/questions/questions-junior-part11.json'
import questionsJuniorPart12 from '../data/questions/questions-junior-part12.json'
import questionsJuniorPart13 from '../data/questions/questions-junior-part13.json'
import questionsJuniorPart14 from '../data/questions/questions-junior-part14.json'
import questionsJuniorPart15 from '../data/questions/questions-junior-part15.json'
import questionsJuniorPart16 from '../data/questions/questions-junior-part16.json'
import questionsJuniorPart17 from '../data/questions/questions-junior-part17.json'
import questionsJuniorPart18 from '../data/questions/questions-junior-part18.json'
// Senior parts
import questionsSeniorPart1 from '../data/questions/questions-senior-part1.json'
import questionsSeniorPart2 from '../data/questions/questions-senior-part2.json'
import questionsSeniorPart3 from '../data/questions/questions-senior-part3.json'
import questionsSeniorPart4 from '../data/questions/questions-senior-part4.json'
import questionsSeniorPart5 from '../data/questions/questions-senior-part5.json'
import questionsSeniorPart6 from '../data/questions/questions-senior-part6.json'
import questionsSeniorPart7 from '../data/questions/questions-senior-part7.json'
import questionsSeniorPart8 from '../data/questions/questions-senior-part8.json'
import questionsSeniorPart9 from '../data/questions/questions-senior-part9.json'
import questionsSeniorPart10 from '../data/questions/questions-senior-part10.json'
import questionsSeniorPart11 from '../data/questions/questions-senior-part11.json'
import questionsSeniorPart12 from '../data/questions/questions-senior-part12.json'
import questionsSeniorPart13 from '../data/questions/questions-senior-part13.json'
import questionsSeniorPart14 from '../data/questions/questions-senior-part14.json'
import type { QuestionData } from '../types/question'
import { parseQuestion } from '../utils/questionParser'

export type DifficultyLevel = 'elementary' | 'junior' | 'senior' | 'elementary1' | 'elementary2' | 'elementary3' | 'elementary4' | 'elementary5' | 'elementary6'

interface QuestionSet {
  level: DifficultyLevel
  title: string
  description: string
  questions: Array<{
    id: string
    sentence: string
    category?: string
  }>
}

// Helper function to merge multiple parts of a question set
function mergeQuestionSets(...parts: QuestionSet[]): QuestionSet {
  const first = parts[0]
  const allQuestions = parts.flatMap((part) => part.questions)
  return {
    level: first.level,
    title: first.title.replace(/ \(Part \d+\/\d+\)/, ''), // Remove part info
    description: first.description,
    questions: allQuestions,
  }
}

// 問題データのマップ
const questionSets: Record<string, QuestionSet> = {
  elementary: questionsElementary as QuestionSet,
  junior: mergeQuestionSets(
    questionsJuniorPart1 as QuestionSet,
    questionsJuniorPart2 as QuestionSet,
    questionsJuniorPart3 as QuestionSet,
    questionsJuniorPart4 as QuestionSet,
    questionsJuniorPart5 as QuestionSet,
    questionsJuniorPart6 as QuestionSet,
    questionsJuniorPart7 as QuestionSet,
    questionsJuniorPart8 as QuestionSet,
    questionsJuniorPart9 as QuestionSet,
    questionsJuniorPart10 as QuestionSet,
    questionsJuniorPart11 as QuestionSet,
    questionsJuniorPart12 as QuestionSet,
    questionsJuniorPart13 as QuestionSet,
    questionsJuniorPart14 as QuestionSet,
    questionsJuniorPart15 as QuestionSet,
    questionsJuniorPart16 as QuestionSet,
    questionsJuniorPart17 as QuestionSet,
    questionsJuniorPart18 as QuestionSet
  ),
  senior: mergeQuestionSets(
    questionsSeniorPart1 as QuestionSet,
    questionsSeniorPart2 as QuestionSet,
    questionsSeniorPart3 as QuestionSet,
    questionsSeniorPart4 as QuestionSet,
    questionsSeniorPart5 as QuestionSet,
    questionsSeniorPart6 as QuestionSet,
    questionsSeniorPart7 as QuestionSet,
    questionsSeniorPart8 as QuestionSet,
    questionsSeniorPart9 as QuestionSet,
    questionsSeniorPart10 as QuestionSet,
    questionsSeniorPart11 as QuestionSet,
    questionsSeniorPart12 as QuestionSet,
    questionsSeniorPart13 as QuestionSet,
    questionsSeniorPart14 as QuestionSet
  ),
  elementary1: mergeQuestionSets(
    questionsElementary1Part1 as QuestionSet,
    questionsElementary1Part2 as QuestionSet,
    questionsElementary1Part3 as QuestionSet,
    questionsElementary1Part4 as QuestionSet,
    questionsElementary1Part5 as QuestionSet,
    questionsElementary1Part6 as QuestionSet
  ),
  elementary2: mergeQuestionSets(
    questionsElementary2Part1 as QuestionSet,
    questionsElementary2Part2 as QuestionSet,
    questionsElementary2Part3 as QuestionSet,
    questionsElementary2Part4 as QuestionSet,
    questionsElementary2Part5 as QuestionSet,
    questionsElementary2Part6 as QuestionSet,
    questionsElementary2Part7 as QuestionSet,
    questionsElementary2Part8 as QuestionSet
  ),
  elementary3: mergeQuestionSets(
    questionsElementary3Part1 as QuestionSet,
    questionsElementary3Part2 as QuestionSet,
    questionsElementary3Part3 as QuestionSet,
    questionsElementary3Part4 as QuestionSet,
    questionsElementary3Part5 as QuestionSet,
    questionsElementary3Part6 as QuestionSet,
    questionsElementary3Part7 as QuestionSet,
    questionsElementary3Part8 as QuestionSet
  ),
  elementary4: mergeQuestionSets(
    questionsElementary4Part1 as QuestionSet,
    questionsElementary4Part2 as QuestionSet,
    questionsElementary4Part3 as QuestionSet,
    questionsElementary4Part4 as QuestionSet,
    questionsElementary4Part5 as QuestionSet,
    questionsElementary4Part6 as QuestionSet,
    questionsElementary4Part7 as QuestionSet,
    questionsElementary4Part8 as QuestionSet
  ),
  elementary5: mergeQuestionSets(
    questionsElementary5Part1 as QuestionSet,
    questionsElementary5Part2 as QuestionSet,
    questionsElementary5Part3 as QuestionSet,
    questionsElementary5Part4 as QuestionSet,
    questionsElementary5Part5 as QuestionSet,
    questionsElementary5Part6 as QuestionSet,
    questionsElementary5Part7 as QuestionSet,
    questionsElementary5Part8 as QuestionSet
  ),
  elementary6: mergeQuestionSets(
    questionsElementary6Part1 as QuestionSet,
    questionsElementary6Part2 as QuestionSet,
    questionsElementary6Part3 as QuestionSet,
    questionsElementary6Part4 as QuestionSet,
    questionsElementary6Part5 as QuestionSet,
    questionsElementary6Part6 as QuestionSet,
    questionsElementary6Part7 as QuestionSet,
    questionsElementary6Part8 as QuestionSet,
    questionsElementary6Part9 as QuestionSet
  ),
}

/**
 * 指定された難易度の問題セットを取得
 */
export function getQuestionSet(difficulty: DifficultyLevel): QuestionSet {
  // elementary選択時は統合された情報を返す
  if (difficulty === 'elementary') {
    return {
      level: 'elementary',
      title: '小学校卒業レベル',
      description: '小学1年生から6年生までの全ての漢字を含む総合問題集',
      questions: [], // 実際の問題は getRandomQuestion で動的に選択
    }
  }

  return questionSets[difficulty as string]
}

/**
 * 指定された難易度からランダムに問題を取得
 */
export function getRandomQuestion(difficulty: DifficultyLevel): QuestionData {
  // elementary選択時は1～6年生の全問題から選択
  if (difficulty === 'elementary') {
    // 1～6年生の全問題を収集
    const allElementaryQuestions: Array<{
      question: { id: string; sentence: string; category?: string }
      level: DifficultyLevel
    }> = []

    const elementaryLevels: DifficultyLevel[] = ['elementary1', 'elementary2', 'elementary3', 'elementary4', 'elementary5', 'elementary6']

    for (const level of elementaryLevels) {
      const set = questionSets[level]
      if (set) {
        for (const question of set.questions) {
          allElementaryQuestions.push({ question, level })
        }
      }
    }

    // 全問題からランダムに1つ選択
    if (allElementaryQuestions.length > 0) {
      const randomIndex = Math.floor(Math.random() * allElementaryQuestions.length)
      const selected = allElementaryQuestions[randomIndex]
      const parsed = parseQuestion(selected.question.sentence)

      return {
        id: selected.question.id,
        originalSentence: selected.question.sentence,
        displaySentence: parsed.displaySentence,
        inputs: parsed.inputs,
        difficulty: selected.level, // 実際の学年レベルを保持
        category: selected.question.category || '',
      }
    }
  }

  // 通常の処理（elementary以外の場合）
  const questionSet = questionSets[difficulty as string]
  const randomIndex = Math.floor(Math.random() * questionSet.questions.length)
  const rawQuestion = questionSet.questions[randomIndex]

  // パースして完全なQuestionDataに変換
  const parsed = parseQuestion(rawQuestion.sentence)

  return {
    id: rawQuestion.id,
    originalSentence: rawQuestion.sentence,
    displaySentence: parsed.displaySentence,
    inputs: parsed.inputs,
    difficulty,
    category: rawQuestion.category || '',
  }
}

/**
 * 全難易度の問題数を取得
 */
export function getQuestionCounts(): Record<string, number> {
  const counts: Record<string, number> = {}

  // 基本の問題数を計算
  for (const [key, set] of Object.entries(questionSets)) {
    counts[key] = set.questions.length
  }

  // elementaryの問題数は1～6年生の合計
  const elementaryTotal =
    (counts.elementary1 || 0) +
    (counts.elementary2 || 0) +
    (counts.elementary3 || 0) +
    (counts.elementary4 || 0) +
    (counts.elementary5 || 0) +
    (counts.elementary6 || 0)

  // questions-elementary.jsonの問題数を上書き
  counts.elementary = elementaryTotal

  return counts
}

/**
 * 指定されたIDの問題を取得
 */
export function getQuestionById(id: string): QuestionData | null {
  for (const [difficulty, questionSet] of Object.entries(questionSets)) {
    const question = questionSet.questions.find((q) => q.id === id)
    if (question) {
      const parsed = parseQuestion(question.sentence)
      return {
        id: question.id,
        originalSentence: question.sentence,
        displaySentence: parsed.displaySentence,
        inputs: parsed.inputs,
        difficulty: difficulty as DifficultyLevel,
        category: question.category || '',
      }
    }
  }
  return null
}

/**
 * カテゴリー一覧を取得
 */
export function getCategories(difficulty?: DifficultyLevel): string[] {
  const categories = new Set<string>()

  if (difficulty) {
    const set = questionSets[difficulty as string]
    if (set) {
      for (const q of set.questions) {
        categories.add(q.category || '')
      }
    }
  } else {
    for (const set of Object.values(questionSets)) {
      for (const q of set.questions) {
        categories.add(q.category || '')
      }
    }
  }

  return Array.from(categories).sort()
}

/**
 * 特定のカテゴリーの問題を取得
 */
export function getQuestionsByCategory(category: string, difficulty?: DifficultyLevel): QuestionData[] {
  const questions: QuestionData[] = []

  const processQuestionSet = (set: QuestionSet, level: DifficultyLevel) => {
    for (const q of set.questions) {
      if (q.category === category) {
        const parsed = parseQuestion(q.sentence)
        questions.push({
          id: q.id,
          originalSentence: q.sentence,
          displaySentence: parsed.displaySentence,
          inputs: parsed.inputs,
          difficulty: level,
          category: q.category || '',
        })
      }
    }
  }

  if (difficulty) {
    const set = questionSets[difficulty as string]
    if (set) {
      processQuestionSet(set, difficulty)
    }
  } else {
    for (const [level, set] of Object.entries(questionSets)) {
      processQuestionSet(set, level as DifficultyLevel)
    }
  }

  return questions
}

/**
 * 指定された難易度の問題を取得
 */
export function getQuestionsByDifficulty(difficulty: DifficultyLevel): QuestionData[] {
  // elementary選択時は1～6年生の全問題を返す
  if (difficulty === 'elementary') {
    const allQuestions: QuestionData[] = []
    const elementaryLevels: DifficultyLevel[] = ['elementary1', 'elementary2', 'elementary3', 'elementary4', 'elementary5', 'elementary6']

    for (const level of elementaryLevels) {
      const set = questionSets[level]
      if (set) {
        for (const q of set.questions) {
          const parsed = parseQuestion(q.sentence)
          allQuestions.push({
            id: q.id,
            originalSentence: q.sentence,
            displaySentence: parsed.displaySentence,
            inputs: parsed.inputs,
            difficulty: level, // 実際の学年レベルを保持
            category: q.category || '',
          })
        }
      }
    }

    return allQuestions
  }

  // 通常の処理（elementary以外の場合）
  const questionSet = questionSets[difficulty as string]
  if (!questionSet) return []

  return questionSet.questions.map((q) => {
    const parsed = parseQuestion(q.sentence)
    return {
      id: q.id,
      originalSentence: q.sentence,
      displaySentence: parsed.displaySentence,
      inputs: parsed.inputs,
      difficulty,
      category: q.category || '',
    }
  })
}

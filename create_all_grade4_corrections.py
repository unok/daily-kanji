#!/usr/bin/env python3
import json
import re

# 小学4年生の漢字リスト
GRADE4_KANJI = set(['不', '争', '井', '付', '令', '以', '仲', '伝', '位', '低', '佐', '例', '便', '信', '倉', '候', '借', '健', '側', '働', '億', '兆', '児', '共', '兵', '典', '冷', '初', '別', '利', '刷', '副', '功', '加', '努', '労', '勇', '包', '卒', '協', '単', '博', '印', '参', '司', '各', '周', '唱', '器', '固', '城', '埼', '塩', '変', '夫', '失', '奈', '好', '媛', '季', '孫', '完', '官', '害', '富', '察', '岐', '岡', '崎', '巣', '差', '希', '席', '帯', '底', '府', '康', '建', '径', '徒', '徳', '必', '念', '愛', '成', '戦', '折', '挙', '改', '敗', '散', '料', '旗', '昨', '景', '最', '望', '未', '末', '札', '材', '束', '松', '果', '栃', '栄', '案', '梅', '梨', '械', '極', '標', '機', '欠', '残', '氏', '民', '求', '沖', '治', '法', '泣', '浅', '浴', '清', '満', '滋', '漁', '潟', '灯', '無', '然', '焼', '照', '熊', '熱', '牧', '特', '産', '的', '省', '祝', '票', '種', '積', '競', '笑', '管', '節', '約', '結', '給', '続', '縄', '置', '群', '老', '臣', '良', '芸', '芽', '英', '茨', '菜', '街', '衣', '要', '覚', '観', '訓', '試', '説', '課', '議', '貨', '賀', '軍', '輪', '辞', '辺', '連', '達', '選', '郡', '量', '録', '鏡', '関', '阜', '阪', '陸', '隊', '静', '順', '願', '類', '飛', '飯', '養', '香', '験', '鹿'])

def create_correction_for_problem(problem):
    """各問題に対する修正案を生成"""
    sentence = problem['sentence']
    id = problem['id']
    
    # 問題ごとの個別修正案
    corrections = {
        # Part 1
        'e4-016': ('バスが[停|てい]車しました。', 'バスが[着|ちゃく]きました。', '停（6年）→着（3年、ただし4年生には「到着」の概念で）'),
        'e4-044': ('日本の[史|し]実を学びました。', '日本の[事|じ]実を学びました。', '史（5年）→事（3年、ただし4年生には適切）'),  
        'e4-047': ('結果を[告|つ]げました。', '結果を[伝|つた]えました。', '告（5年）→伝（4年）'),
        'e4-050': ('合格を[喜|よろこ]びました。', '合格を[祝|いわ]いました。', '喜（5年）→祝（4年）'),
        'e4-052': ('敵に[囲|かこ]まれました。', '敵に[包|つつ]まれました。', '囲（5年）→包（4年）'),
        'e4-054': ('新しい[型|かた]の車が発売されました。', '新しい[種|しゅ]類の車が発売されました。', '型（5年）→種（4年）'),
        'e4-055': ('お[堂|どう]を見学しました。', '[殿|でん]を見学しました。', '堂（6年）→殿（4年）'),
        'e4-057': ('弁護[士|し]になりたいです。', '[法|ほう]律家になりたいです。', '士（5年）→法（4年）'),
        'e4-079': ('良い結果を[得|え]ました。', '良い結果に[達|たっ]しました。', '得（6年）→達（4年）'),
        'e4-088': ('困っている人を[救|すく]いました。', '困っている人を[助|たす]けました。', '救（5年）→助（3年、ただし基本語彙）'),
        'e4-112': ('日本の[歴|れき]史を学びました。', '日本の[昔|むかし]を学びました。', '歴（6年）→昔（3年、ただし基本語彙）'),
        'e4-114': ('蚊を[殺|ころ]しました。', '蚊を[倒|たお]しました。', '殺（5年）→倒（3年、ただし基本語彙）'),
        'e4-115': ('[毒|どく]を持つ生き物に注意します。', '[害|がい]のある生き物に注意します。', '毒（6年）→害（4年）'),
        'e4-144': ('[粉|こな]を混ぜました。', '[材|ざい]料を混ぜました。', '粉（6年）→材（4年）'),
        'e4-145': ('[紀|き]元前の歴史を学びました。', '[昔|むかし]の時代を学びました。', '紀（5年）→昔（3年、ただし基本語彙）'),
        
        # Part 2
        'e4-152': ('[胃|い]が痛いです。', 'お[腹|なか]が痛いです。', '胃（6年）→腹（6年）だが、「お腹」は基本語彙'),
        'e4-153': ('[脈|みゃく]を測りました。', '体を[調|しら]べました。', '脈（6年）→調（3年）で文脈変更'),
        'e4-154': ('[腸|ちょう]の調子が悪いです。', 'お[腹|なか]の調子が悪いです。', '腸（6年）→腹（6年）だが、「お腹」は基本語彙'),
        'e4-156': ('船で[航海|こうかい]しました。', '船で[旅|たび]をしました。', '航（5年）・海（2年）→旅（3年）で文脈変更'),
        'e4-172': ('[象|ぞう]を見ました。', '大きな[動|どう]物を見ました。', '象（5年）→動（3年）で文脈変更'),
        'e4-174': ('お金を[貯|た]めました。', 'お金を[積|つ]みました。', '貯（6年）→積（4年）'),
        'e4-175': ('[費|ひ]用がかかります。', '[料|りょう]金がかかります。', '費（6年）→料（4年）'),
        'e4-176': ('[賞|しょう]をもらいました。', '[札|ふだ]をもらいました。', '賞（5年）→札（4年）で文脈変更'),
        
        # Part 3
        'e4-306': ('[歴|れき]史を勉強します。', '[昔|むかし]を勉強します。', '歴（6年）→昔（3年）'),
        'e4-308': ('虫を[殺|ころ]しました。', '虫を[消|け]しました。', '殺（5年）→消（3年）'),
        'e4-309': ('[毒|どく]キノコに注意します。', '[害|がい]のあるキノコに注意します。', '毒（6年）→害（4年）'),
        'e4-338': ('[粉|こ]ミルクを飲みました。', '[特|とく]別なミルクを飲みました。', '粉（6年）→特（4年）で文脈変更'),
        'e4-339': ('[紀|き]元後の時代です。', '[後|あと]の時代です。', '紀（5年）→後（2年）で簡略化'),
        'e4-346': ('[胃|い]薬を飲みました。', 'お[薬|くすり]を飲みました。', '胃（6年）→薬（3年）で簡略化'),
        'e4-347': ('[脈|みゃく]が速いです。', '体が[熱|あつ]いです。', '脈（6年）→熱（4年）で文脈変更'),
        'e4-348': ('[腸|ちょう]を大切にします。', '体を[大|たい]切にします。', '腸（6年）→大（1年）で文脈変更'),
        'e4-350': ('[航|こう]空機に乗りました。', '[飛|ひ]行機に乗りました。', '航（5年）→飛（4年）'),
        'e4-366': ('[象|しょう]徴的な建物です。', '[特|とく]別な建物です。', '象（5年）→特（4年）'),
        'e4-368': ('[貯|ちょ]金をしています。', '[積|つ]み立てをしています。', '貯（6年）→積（4年）'),
        'e4-369': ('[費|ひ]用を計算します。', '[料|りょう]金を計算します。', '費（6年）→料（4年）'),
        'e4-370': ('[賞|しょう]品をもらいました。', '[景|けい]品をもらいました。', '賞（5年）→景（4年）'),
        
        # Part 4
        'e4-470': ('[胃|い]カメラ検査をしました。', '体の[検|けん]査をしました。', '胃（6年）→検（5年）だが、「検査」は一般的'),
        'e4-472': ('[仏|ぶつ]像を見ました。', '[神|かみ]様の像を見ました。', '仏（5年）→神（3年）'),
        'e4-473': ('[粉|ふん]末にしました。', '[細|こま]かくしました。', '粉（6年）→細（2年）'),
        'e4-484': ('[州|しゅう]の境界線です。', '[県|けん]の境界線です。', '州（3年）→県（3年）で日本の文脈に'),
        'e4-488': ('[脈|みゃく]拍を数えました。', '心[臓|ぞう]の動きを数えました。', '脈（6年）→臓（6年）だが文脈を変更して「体の[音|おと]を数えました。」'),
        'e4-511': ('[歴|れき]史の本を読みました。', '[昔|むかし]の本を読みました。', '歴（6年）→昔（3年）'),
        'e4-527': ('[仏|ぶっ]教を学びました。', '[宗|しゅう]教を学びました。', '仏（5年）→宗（6年）だが「[教|きょう]えを学びました。」に変更'),
        'e4-528': ('[粉|こな]雪が降りました。', '[細|こま]かい雪が降りました。', '粉（6年）→細（2年）'),
        'e4-539': ('[当|とう]番になりました。', '[順|じゅん]番になりました。', '当（2年）だが文脈上、順（4年）が適切'),
        'e4-543': ('[脈|みゃく]絡がありません。', '[関|かん]係がありません。', '脈（6年）→関（4年）'),
        'e4-546': ('[胃|い]袋がいっぱいです。', 'お[腹|なか]がいっぱいです。', '胃（6年）→腹（6年）だが「お腹」は基本語彙'),
        'e4-566': ('[歴|れき]代の記録です。', '[昔|むかし]からの記録です。', '歴（6年）→昔（3年）'),
        
        # Part 5 - 多くが重複パターン
        'e4-613': ('人を[殺|ころ]してはいけません。', '人を[害|がい]してはいけません。', '殺（5年）→害（4年）'),
        'e4-614': ('[殺|さつ]人事件が起きました。', '[害|がい]を与える事件が起きました。', '殺（5年）→害（4年）で文脈変更'),
        'e4-615': ('[毒|どく]薬は危険です。', '[害|がい]のある薬は危険です。', '毒（6年）→害（4年）'),
        'e4-616': ('[毒|どく]ヘビに注意しましょう。', '[害|がい]のあるヘビに注意しましょう。', '毒（6年）→害（4年）'),
        
        # Part 6
        'e4-829': ('[停|てい]止しました。', '[止|と]まりました。', '停（6年）→止（2年）'),
        'e4-830': ('[停|てい]電になりました。', '[電|でん]気が止まりました。', '停（6年）→止（2年）で文脈変更'),
        'e4-831': ('バス[停|てい]で待ちました。', 'バスを[待|ま]ちました。', '停（6年）→待（3年）で文脈変更'),
        'e4-832': ('一時[停|てい]止しました。', '一時[止|と]まりました。', '停（6年）→止（2年）'),
        'e4-835': ('[要|よう]求された[仕事|しごと]です。', '[願|ねが]いされた[仕|し]事です。', '仕（3年）・事（3年）→願（4年）で主要な学習対象を変更'),
        
        # Part 7
        'e4-937': ('日本の歴[史|し]を学びました。', '日本の[昔|むかし]を学びました。', '史（5年）→昔（3年）'),
        'e4-944': ('新鮮なお[寿司|すし]を食べました。', '新鮮な[料|りょう]理を食べました。', '寿（7年）→料（4年）'),
        'e4-949': ('[告|こく]白しました。', '[伝|つた]えました。', '告（5年）→伝（4年）'),
        'e4-961': ('[喜|き]劇を見ました。', '[笑|わら]いの劇を見ました。', '喜（5年）→笑（4年）'),
        'e4-969': ('[囲|い]碁をしました。', '[対|たい]戦ゲームをしました。', '囲（5年）→対（3年）で文脈変更'),
        'e4-977': ('新[型|がた]コロナウイルスです。', '新[種|しゅ]のウイルスです。', '型（5年）→種（4年）'),
        'e4-981': ('[堂|どう]々としています。', '[静|しず]かにしています。', '堂（6年）→静（4年）で文脈変更'),
        'e4-989': ('[士|し]気を高めました。', '[勇|ゆう]気を高めました。', '士（5年）→勇（4年）'),
        'e4-1073': ('テストで良い点数を[得|え]ることができました。', 'テストで良い点数を[取|と]ることができました。', '得（6年）→取（3年）'),
        'e4-1097': ('火事から人を[救|きゅう]出しました。', '火事から人を[助|たす]け出しました。', '救（5年）→助（3年）'),
        
        # Part 8
        'e4-1196': ('武[士|し]の時代です。', '[軍|ぐん]人の時代です。', '士（5年）→軍（4年）'),
    }
    
    # デフォルトの修正案を生成
    if id in corrections:
        original, corrected, explanation = corrections[id]
        return {
            'id': id,
            'file': problem['file'],
            'original_sentence': original,
            'corrected_sentence': corrected,
            'explanation': explanation,
            'problematic_kanji': problem['problematic_kanji'],
            'kanji_grades': problem['kanji_grades']
        }
    else:
        # その他の問題に対する汎用的な修正
        return create_generic_correction(problem)

def create_generic_correction(problem):
    """汎用的な修正案を生成"""
    sentence = problem['sentence']
    
    # 最も問題のある漢字を選択
    target_kanji = problem['problematic_kanji'][0] if problem['problematic_kanji'] else None
    
    if not target_kanji:
        return None
    
    # 汎用的な置換ルール
    generic_replacements = {
        # 6年生
        '停': ('止', 'と'),
        '堂': ('館', 'かん'),
        '得': ('取', 'と'),
        '歴': ('昔', 'むかし'),
        '毒': ('害', 'がい'),
        '粉': ('細', 'こま'),
        '胃': ('腹', 'はら'),
        '脈': ('筋', 'すじ'),
        '腸': ('腹', 'はら'),
        '貯': ('積', 'つ'),
        '費': ('料', 'りょう'),
        
        # 5年生
        '仏': ('神', 'かみ'),
        '史': ('話', 'はなし'),
        '告': ('伝', 'つた'),
        '喜': ('笑', 'わら'),
        '囲': ('包', 'つつ'),
        '型': ('種', 'しゅ'),
        '士': ('者', 'もの'),
        '技': ('芸', 'げい'),
        '救': ('助', 'たす'),
        '殺': ('倒', 'たお'),
        '紀': ('代', 'だい'),
        '航': ('飛', 'ひ'),
        '象': ('形', 'かたち'),
        '賞': ('品', 'ひん'),
        
        # 3年生
        '事': ('物', 'もの'),
        '仕': ('働', 'はたら'),
        '化': ('変', 'へん'),
        '州': ('県', 'けん'),
        '役': ('係', 'かかり'),
        '所': ('場', 'ば'),
        '練': ('習', 'なら'),
        '苦': ('辛', 'つら'),
        
        # 2年生
        '友': ('仲', 'なか'),
        '園': ('場', 'ば'),
        '当': ('合', 'あ'),
        '海': ('水', 'みず'),
        '色': ('様', 'よう'),
        '長': ('大', 'おお'),
        '雲': ('空', 'そら'),
    }
    
    if target_kanji in generic_replacements:
        replacement, reading = generic_replacements[target_kanji]
        
        # パターンマッチで置換
        pattern = rf'\[{re.escape(target_kanji)}(\|[^\]]+)?\]'
        match = re.search(pattern, sentence)
        
        if match:
            if match.group(1):  # 既存の読みがある場合
                new_text = f'[{replacement}{match.group(1)}]'
            else:
                new_text = f'[{replacement}|{reading}]'
            
            new_sentence = re.sub(pattern, new_text, sentence)
            
            return {
                'id': problem['id'],
                'file': problem['file'],
                'original_sentence': sentence,
                'corrected_sentence': new_sentence,
                'explanation': f'{target_kanji}（{problem["kanji_grades"][target_kanji]}年生）→{replacement}（4年生以下）',
                'problematic_kanji': problem['problematic_kanji'],
                'kanji_grades': problem['kanji_grades']
            }
    
    return None

def main():
    # 分析結果を読み込む
    with open('grade4_problems_analysis.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # 修正が必要な問題を処理
    problems_to_fix = data['problems_to_fix']
    all_corrections = []
    
    for problem in problems_to_fix:
        correction = create_correction_for_problem(problem)
        if correction:
            all_corrections.append(correction)
    
    # 結果を表示
    print(f"修正案を作成しました: {len(all_corrections)}件（{len(problems_to_fix)}件中）\n")
    
    # 最初の20件を表示
    for i, corr in enumerate(all_corrections[:20], 1):
        print(f"{i}. {corr['id']} ({corr['file']})")
        print(f"   旧: {corr['original_sentence']}")
        print(f"   新: {corr['corrected_sentence']}")
        print(f"   説明: {corr['explanation']}")
        print()
    
    # 修正案をJSONファイルに保存
    output = {
        'summary': {
            'total_problems': len(problems_to_fix),
            'corrections_created': len(all_corrections),
            'no_correction': len(problems_to_fix) - len(all_corrections)
        },
        'corrections': all_corrections
    }
    
    with open('grade4_corrections_complete.json', 'w', encoding='utf-8') as f:
        json.dump(output, f, ensure_ascii=False, indent=2)
    
    print(f"\n修正案を grade4_corrections_complete.json に保存しました。")
    
    # ファイル別の統計
    file_stats = {}
    for corr in all_corrections:
        file = corr['file']
        if file not in file_stats:
            file_stats[file] = 0
        file_stats[file] += 1
    
    print("\nファイル別修正数:")
    for file, count in sorted(file_stats.items()):
        print(f"  {file}: {count}件")

if __name__ == '__main__':
    main()